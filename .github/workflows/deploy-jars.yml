name: Deploy JARs to EC2

on:
  push:
    branches: [ main ]
    paths:
      - 'voyager-datasync/**'
  workflow_dispatch:

jobs:
  deploy-jars:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build JARs
        run: mvn clean package -DskipTests -pl voyager-datasync -Pmultiple-jar-profile

      - name: List generated JARs
        run: |
          echo "=== Generated JARs ==="
          ls -lh voyager-datasync/target/*.jar
          echo "====================="

      - name: Deploy to EC2 directory
        env:
          PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          HOST: ec2-13-57-240-243.us-west-1.compute.amazonaws.com
        run: |
          # Save SSH key
          echo "$PRIVATE_KEY" > private_key && chmod 600 private_key
          
          # Create target directory on EC2
          echo "Creating directory /home/ec2-user/datasync on EC2..."
          ssh -o StrictHostKeyChecking=no -i private_key ec2-user@$HOST "
            mkdir -p /home/ec2-user/datasync
            echo 'Current contents of /home/ec2-user/datasync:'
            ls -la /home/ec2-user/datasync/ 2>/dev/null || echo 'Directory is empty'
          "
          
          # Copy all JAR files to EC2
          echo "Copying JAR files to EC2..."
          scp -o StrictHostKeyChecking=no -i private_key \
            voyager-datasync/target/*.jar \
            ec2-user@$HOST:/home/ec2-user/datasync/
          
          # Verify deployment
          echo "Verifying deployment..."
          ssh -o StrictHostKeyChecking=no -i private_key ec2-user@$HOST "
            echo '=== Deployment Successful ==='
            echo 'JAR files deployed to /home/ec2-user/datasync/:'
            ls -lh /home/ec2-user/datasync/*.jar
            echo '============================'
          "
          
          echo "âœ… JAR files deployed successfully!"
name: Publish Modules to GitHub Packages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17 and Maven
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          server-id: github
          server-username: GITHUB_ACTOR
          server-password: GITHUB_TOKEN

      - name: Try to deploy (will fail if version exists)
        id: deploy-attempt
        continue-on-error: true
        run: |
          # First compile to ensure we can get version info
          mvn clean compile -DskipTests
          
          # Try to deploy - this will fail if version already exists
          mvn deploy -DskipTests
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if deploy succeeded
        id: deploy-result
        run: |
          if [ "${{ steps.deploy-attempt.outcome }}" == "success" ]; then
            echo "Deployment successful - version was new"
            echo "deployed=true" >> $GITHUB_OUTPUT
          else
            echo "Deployment failed - version likely already exists"
            echo "deployed=false" >> $GITHUB_OUTPUT
          fi

      - name: Handle deployment result
        run: |
          if [ "${{ steps.deploy-result.outputs.deployed }}" == "true" ]; then
            echo "✅ Successfully published new version to GitHub Packages"
          else
            echo "ℹ️ Version already exists in GitHub Packages. Nothing to publish."
          fi
